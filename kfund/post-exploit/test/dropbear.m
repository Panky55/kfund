//
//  dropbear.m
//  kfund
//
//  Created by Seo Hyun-gyu on 1/3/24.
//

#import <Foundation/Foundation.h>
#import <spawn.h>
#import <sys/stat.h>
#import "../utils.h"
#import "dropbear.h"
#import "../trustcache.h"
#import "../../ViewController.h"

extern char **environ;

int untarDropbearBootstrap(void) {
    posix_spawnattr_t attr;
    posix_spawnattr_init(&attr);
    posix_spawnattr_setflags(&attr, POSIX_SPAWN_START_SUSPENDED);
    
    NSString *tarPath = [NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/tar"];
    chmod(tarPath.UTF8String, 0755);
    const char* iosbinpackPath = [NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/iosbinpack.tar"].UTF8String;
    
    util_runCommand(tarPath.UTF8String, "--preserve-permissions", "-xkf", iosbinpackPath, "-C", "/var/containers/Bundle/", NULL);
    
    return 0;
}

int setupSSH(void) {
    //----- setup SSH -----//
    NSError *error = NULL;
    
    mkdir("/var/dropbear", 0777);
    removeFile("/var/profile");
    removeFile("/var/motd");
    chmod("/var/profile", 0777);
    chmod("/var/motd", 0777); //this can be read-only but just in case
    copyFile("/var/containers/Bundle/iosbinpack64/etc/profile", "/var/profile");
    copyFile("/var/containers/Bundle/iosbinpack64/etc/motd", "/var/motd");
    
    return 0;
}

int runSSH(void) {
    //load trustcache tar, iosbinpack binaries
    uint64_t tc = staticTrustCacheUploadFileAtPath([NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/tar.tc"], NULL);
    print_log("loaded trustcache tar.tc, ret: 0x%llx", tc);
    tc = staticTrustCacheUploadFileAtPath([NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/iosbinpack.tc"], NULL);
    print_log("loaded trustcache tar.tc, ret: 0x%llx", tc);
    
    //1. bootstrap iosbinpack.tar
    cleanDropbearBootstrap();
    untarDropbearBootstrap();
    
    //2.setup dropbear
    setupSSH();
    
    //3. run SSH
    util_runCommand("/var/containers/Bundle/iosbinpack64/usr/bin/killall", "-SEGV", "dropbear", NULL, NULL, NULL, NULL, NULL);
    int ret = launch("/var/containers/Bundle/iosbinpack64/usr/local/bin/dropbear", "-R", "--shell", "/var/containers/Bundle/iosbinpack64/bin/bash", "-E", "-p", "2222", "-a", NULL);
    print_log("launched dropbear, ret: %d", ret);
    
    return 0;
}

int cleanDropbearBootstrap(void) {
    remove("/var/containers/Bundle/._iosbinpack64");
    remove("/var/mobile/.bash_history");
    remove("/var/root/.bash_history");
    [[NSFileManager defaultManager] removeItemAtPath:@"/var/containers/Bundle/iosbinpack64" error:nil];
    [[NSFileManager defaultManager] removeItemAtPath:@"/var/profile" error:nil];
    [[NSFileManager defaultManager] removeItemAtPath:@"/var/motd" error:nil];
    
    return 0;
}
