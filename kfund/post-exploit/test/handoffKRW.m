//
//  handoffKRW.m
//  kfund
//
//  Created by Seo Hyun-gyu on 1/4/24.
//

#import <Foundation/Foundation.h>
#import "../trustcache.h"
#import "../utils.h"
#import "../handoff/KernelRwWrapper.h"
#import "../proc.h"
#import "../krw.h"
#import <spawn.h>
#import <sys/stat.h>
#import <pthread.h>

void* run_testkernrw(void* arg) {
    const char* path = [NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/test-kernrw"].UTF8String;
    util_runCommand(path, NULL, NULL);
    return NULL;
}

void save_kslide(void) {
    NSString* save_path = @"/tmp/kfund.plist";
    
    NSDictionary *dictionary = @{
        @"kslide": @(get_kslide()),
    };
    
    BOOL success = [dictionary writeToFile:save_path atomically:YES];
    if (!success) {
        printf("[-] Failed createPlistAtPath.\n");
    }
}

void test_handoffKRW(void) {
    
    NSString* tcpath = [NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/test-kernrw.tc"];
    uint64_t trustCacheKaddr = staticTrustCacheUploadFileAtPath(tcpath, NULL);
    printf("trustCacheKaddr: 0x%llx\n", trustCacheKaddr);
    
    const char* path = [NSString stringWithFormat:@"%@%@", NSBundle.mainBundle.bundlePath, @"/binaries/test-kernrw"].UTF8String;
    chmod(path, 0755);
    
    pthread_t thread;
    if (pthread_create(&thread, NULL, run_testkernrw, NULL) != 0) {
        perror("pthread_create failed");
        return;
    }
    usleep(10000);
    pid_t test_pid = pid_by_name("test-kernrw");
    handoffKernRw(test_pid, path);
}
